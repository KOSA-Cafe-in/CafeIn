<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!-- 게시판 MyBatis 매퍼 XML (담당 : 나규태) -->
<mapper namespace="com.cafein.board.mapper.BoardMapper">
	<!-- 특정 카페 게시글 전체조회 -->
	<select id="findAllBoardList" resultType="com.cafein.board.BoardDTO" parameterType="long">
		SELECT boardId, cafeId, userId, title, content, pictureUrl AS boardPictureUrl, createdDate, modifiedDate 
		FROM Board 
		WHERE cafeId = #{cafeId} 
		ORDER BY createdDate DESC, boardId DESC
	</select>
	
	<!-- 게시글 상세 조회 (추가) -->
    <select id="findBoardById" resultType="com.cafein.board.BoardDTO" parameterType="long">
        SELECT boardId, cafeId, userId, title, content, pictureUrl AS boardPictureUrl, createdDate, modifiedDate 
        FROM Board 
        WHERE boardId = #{boardId}
    </select>
    
	<!-- 특정 카페 게시글 전체조회 -->
	<select id="findAllBoardListWithUser" resultType="com.cafein.board.BoardWithUserDTO" parameterType="long">
		SELECT 
			b.boardId, 
			b.cafeId, 
			b.userId, 
			b.title, 
			b.content, 
			b.pictureUrl AS boardPictureUrl, 
			b.createdDate, 
			b.modifiedDate,
			u.nickname
		FROM Board b
		INNER JOIN Users u ON b.userId = u.userId
		WHERE b.cafeId = #{cafeId} 
		ORDER BY createdDate DESC
	</select>
	
	<!-- 게시글 상세 조회 (추가) -->
    <select id="findBoardByIdWithUser" resultType="com.cafein.board.BoardWithUserDTO" parameterType="long">
        SELECT 
			b.boardId, 
			b.cafeId, 
			b.userId, 
			b.title, 
			b.content, 
			b.pictureUrl AS boardPictureUrl, 
			b.createdDate, 
			b.modifiedDate,
			u.nickname
		FROM Board b
		INNER JOIN Users u ON b.userId = u.userId
		WHERE b.boardId = #{boardId} 
    </select>
	
	  <!-- 게시글 등록: Oracle null 처리 개선 -->
	  <insert id="createBoard" parameterType="com.cafein.board.BoardDTO">
	    INSERT INTO Board (
	        boardId, 
	        cafeId, 
	        userId, 
	        title, 
	        content
	        <if test="boardPictureUrl != null and boardPictureUrl != ''">, pictureUrl</if>
	    ) VALUES (
	        BOARD_SEQ.NEXTVAL, 
	        #{cafeId}, 
	        #{userId}, 
	        #{title}, 
	        #{content}
	        <if test="boardPictureUrl != null and boardPictureUrl != ''">, #{boardPictureUrl}</if>
	    )
	  </insert>

	<!-- 게시글 수정: pictureUrl null 처리 + boardId 수정 -->
	<update id="updateBoard" parameterType="com.cafein.board.BoardDTO">
	    UPDATE Board
	    <set>
	        <if test="title != null and title != ''">
	            title = #{title},
	        </if>
	        <if test="content != null and content != ''">
	            content = #{content},
	        </if>
	        <if test="boardPictureUrl != null">
	            pictureUrl = #{boardPictureUrl},
	        </if>
	        modifiedDate = SYSDATE
	    </set>
	    WHERE boardId = #{boardId}
	</update>

	<!-- 게시글 삭제 -->
	<delete id="deleteBoard" parameterType="long">
	  DELETE FROM Board
	  WHERE boardId = #{boardId}  
	</delete>
	
	<!-- 무한스크롤을 위한 페이징 조회 -->
	<select id="findBoardListWithPaging" resultType="com.cafein.board.BoardWithUserDTO">
		SELECT 
			b.boardId, 
			b.cafeId, 
			b.userId, 
			b.title, 
			b.content, 
			b.pictureUrl AS boardPictureUrl, 
			b.createdDate, 
			b.modifiedDate,
			u.nickname
		FROM Board b
		INNER JOIN Users u ON b.userId = u.userId
		WHERE b.cafeId = #{cafeId} 
		ORDER BY b.boardId DESC
		OFFSET #{offset} ROWS FETCH NEXT #{size} ROWS ONLY
	</select>
	
	<!-- 특정 카페의 전체 게시글 수 조회 -->
	<select id="getTotalBoardCount" resultType="int" parameterType="long">
		SELECT COUNT(*)
		FROM Board 
		WHERE cafeId = #{cafeId}
	</select>
 </mapper> 